/*===========================================================================*
 * File:        rcc.c
 * Project:     ECU
 * Author:      Mateusz Mroz
 * Date:        13.09.2021
 * Brief:       RCC - Reset and clock control registers
 *===========================================================================*/

/*===========================================================================*
 *
 * INCLUDE SECTION
 *
 *===========================================================================*/

#include "rcc.h"

/*===========================================================================*
 *
 * DEFINES AND MACRO SECTION
 *
 *===========================================================================*/

#define RCC_MAX_CYCLES          1000u

/*===========================================================================*
 *
 * LOCAL TYPES AND ENUMERATION SECTION
 *
 *===========================================================================*/

/*===========================================================================*
 *
 * GLOBAL VARIABLES AND CONSTANTS SECTION
 *
 *===========================================================================*/

/*===========================================================================*
 *
 * LOCAL FUNCTION DECLARATION SECTION
 *
 *===========================================================================*/

/*===========================================================================*
 *
 * FUNCTION DEFINITION SECTION
 *
 *===========================================================================*/

/*===========================================================================*
 *
 * LOCAL FUNCTION DEFINITION SECTION
 *
 *===========================================================================*/

/*===========================================================================*
 * Function: RCC_ClockInit
 *===========================================================================*/
void RCC_ClockInit(void)
{
    uint32_t elapsedCycles = 0;

    /* Turn HSE OSC On */
    RCC->CR |= RCC_CR_HSEON;
    /* Wait for HSE Ready flag */
    while ((!RCC->CR & RCC_CR_HSERDY) || (elapsedCycles < RCC_MAX_CYCLES))
    {
        elapsedCycles++;
    }

    if (elapsedCycles >= RCC_MAX_CYCLES)
    {
        NVIC_SystemReset();
    }
    /* AHB prescaler = 1 => HCLK = 100[MHz] */
    RCC->CFGR |= RCC_CFGR_HPRE_DIV1;
    /* APB2 prescaler = 1 => APB2 = 100[MHz] */
    RCC->CFGR |= RCC_CFGR_PPRE2_DIV1;
    /* APB1 prescaler = 2 => APB1 = 50[MHz] */
    RCC->CFGR |= RCC_CFGR_PPRE1_DIV2;



}


/* end of file */
